# USV_QT 项目（无人船上位机示例）

> 一个用 Qt 做的简单上位机：看数据、调参数、发指令，不追求专业严谨，只求“能跑能改”。

## 1. 项目整体功能概述

本项目模拟/处理无人船运行过程中的定位、姿态、速度和控制。主要做了几件事：

- 实时显示 6 条曲线：`x, y, ψ(偏航角), r(角速度), u(前向速度), v(侧向速度)`，还有对应的红色“参考”曲线。
- 支持参考值为“正弦跟踪”：每个变量都有 基值 / 幅值 / 周期，可做简单轨迹与速度跟踪实验。
- 提供多种控制模式（通过内部 `flag / flag_control` 切换）：热身、巡点、APF-LOS 路径跟踪、轨迹跟踪、速度跟踪、角速度跟踪、停止、MPC-CBF-ST（占位）等。
- 角速度跟踪：增量式 PID 或 SMC 滑模控制二选一。
- 线速度 u / v 跟踪：增量式 PID（简化版）。
- EKF / ESO：示例性滤波与状态估计（用于姿态/速度平滑）。
- 参数对话框：滤波参数、控制算法参数、正弦跟踪参考参数，都能在界面里调。
- CSV 导出：当前绘图数据 + 参考值一起保存。

## 2. 目录 & 关键文件

| 文件 | 作用简述 |
|------|----------|
| `mainwindow.*` | 主窗口，按钮和启动绘图定时器。|
| `plotwindow.*` | 曲线绘图窗口 + 菜单（显示模式/导出/滤波/跟踪/控制）。|
| `control_thread.*` | 控制循环，定时器回调里根据模式做控制，含增量 PID / SMC。|
| `tracking_params.*` | 全局参考：实时值 + 正弦参数（基值/幅值/周期）+ `update_tracking_refs()`。|
| `tracking_config_dialog.*` | 设置各变量正弦跟踪参数。|
| `control_alg_params.*` | 控制算法全局参数（PID/SMC增益、模式选择）。|
| `control_alg_config_dialog.*` | 控制算法参数对话框（切换 PID / SMC 并调增益）。|
| `ekf_localization.*` | 简化 EKF 定位融合。|
| `ekf_config_dialog.*` | EKF 参数调节窗口。|
| `eso.*` | 扩张状态观测器（ESO）示例。|
| `map_set.*` | 路径 / 障碍相关的配置界面（APF 用）。|

## 3. 用户基本使用流程（最简单体验）

1. 用 Qt Creator 打开工程 `QT_test.pro`（或命令行 `qmake && make`）。
2. 运行程序，进入主窗口。
3. 点击“绘制曲线”按钮：弹出曲线窗口开始实时刷新。
4. 打开“跟踪”→“跟踪目标设置”：设定某些变量的幅值和周期（例如给 `r` 幅值 0.5 周期 10）。
5. 切换到对应控制模式（例如把 `flag` 设为 8 进行速度跟踪，或设为 6 做角速度跟踪）。
6. 在“控制”菜单里调 PID / SMC 参数尝试不同响应。
7. 如需导出数据：“数据”→“导出CSV”。

（注：若只看曲线、不跑控制线程，正弦参考也会随绘图定时器时间演化。）

## 4. 菜单 / 对话框说明

- 显示模式：弧度 / 角度切换（只影响 ψ、r 展示单位）。
- 数据：导出当前窗口内所有样本为 CSV（含参考值）。
- 滤波：打开 EKF 参数设置窗口（根据需要微调）。
- 跟踪：正弦参考设置（基值 + 幅值 + 周期，幅值=0 或 周期<=0 表示常值）。
- 控制：PID / SMC 切换与增益调节（角速度专用）。

## 5. 控制模式（核心在 `control_thread.cpp` 的 `switch(flag_control)`）

| 模式值 | 描述 |
|--------|------|
| 0 | warm up：逐步提升推进器输出到巡航速度。|
| 2 | 巡点导航：根据预设点转向 + 前进。|
| 3 | APF-LOS：人工势场生成路径 + LOS 导航。|
| 4 | 轨迹跟踪：按设定轨迹参数（圆等）+ 滑模转向。|
| 6 | 角速度跟踪：增量式 PID 或 SMC 控制 `r`。|
| 8 | 线速度跟踪：增量式 PID 控制 `u` 和 `v`。|
| 9 | 停止：推进器停转。|
| 其它 | 示例/占位或未完全实现（如 MPC-CBF-ST）。|

切换条件：`flag` 决定 `flag_control`，具体在控制线程前半部分映射，可按需要扩展。

## 6. 数据采样与参考曲线

- 调用 `PlotWindow::addSample()` 时记录实际值 + 当时参考值，保证导出 CSV 与画面一致。
- 正弦参考由 `update_tracking_refs(Ts)` 或绘图定时器调用定期刷新。
- 角速度跟踪启用条件：`ref_r_amp > 0`（幅值为 0 只显示常值参考，不驱动控制）。

## 7. 自定义接口 / 扩展点

| 扩展点 | 如何做 |
|--------|--------|
| 新控制模式 | 在 `control_thread.cpp` 中增加 `case`，维护自己的状态变量。|
| 新参考类型 | 在 `tracking_params.*` 中添加生成函数并在定时器里调用。|
| 新算法参数 | 放到相应的 `*_params.*` 全局变量里 + 增加对话框输入控件。|
| 曲线数量 | 修改 `plotwindow.*`：添加新的 `QLineSeries` 和轴。|
| 数据源模拟 | 在主窗口定时器里生成或接入真实传感器数据。|
| 外部协议 | 在合适位置加入 TCP / 串口 / ROS2 节点代码。|

## 8. 后续可拓展功能建议

- PID 抗积分饱和、微分低通滤波。
- 统一总控面板：把滤波、正弦、控制算法合并到一个标签页。
- 更精确的动力学模型（加入阻尼、推进器曲线、质量变化）。
- 路径规划改进：动态避障、重规划触发策略优化。
- 日志系统：按时间分段保存、支持回放/对比。
- 网络远程监控：WebSocket / HTTP 接口查看实时曲线。
- 导入外部参考：CSV 或实时流作为 ref_* 驱动。
- 仿真模式：无硬件时生成虚拟运动模型进行闭环测试。

## 9. 快速构建与运行（示例）

Qt Creator：直接打开 `QT_test.pro`，配置 Kits，编译运行。

命令行（Windows 使用 MSYS 或在 Qt 安装命令行环境）：

```bash
qmake QT_test.pro
make   # 或 nmake / jom 取决于环境
./QT_test.exe
```

## 10. 常见疑问（简单版）

- 参考曲线不动？检查幅值是否 > 0 或周期是否 > 0；只开绘图窗口也会刷新。
- 角速度不受控？确认控制模式进入 case 6，`g_r_track_mode` 设为 PID 或 SMC，且 `ref_r_amp > 0`。
- 数据导出为空？确保已经点击“绘制曲线”并等待定时器采样。

## 11. 免责声明

示例性质代码，很多细节（物理参数、通信、误差处理）都做了简化，适合学习和实验，不适合直接上船使用。

欢迎继续按自己的需求“魔改”。


